
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CivicRevolution - Home</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgb(255, 255, 255);
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0px) rotate(0deg);
      }

      33% {
        transform: translateY(-30px) rotate(1deg);
      }

      66% {
        transform: translateY(20px) rotate(-1deg);
      }
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }

    header {
      position: relative;

      background:
        linear-gradient(135deg, rgba(94, 57, 230, 0.85), rgba(168, 70, 198, 0.85)),
        url('https://www.varsitytech.com/wp-content/uploads/2022/12/Screen-Shot-2022-12-07-at-11.10.13-AM.png') center/cover;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      color: #fff;
      overflow: hidden;
      height: 400px;
    }


    header h2 {
      position: relative;
      z-index: 2;
      margin: 0;
      font-size: 2.5rem;
      color: white;
    }


    header::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      opacity: 0.15;
    }

    @keyframes gradientShift {
      0% {
        background-position: 0% 50%
      }

      50% {
        background-position: 100% 50%
      }

      100% {
        background-position: 0% 50%
      }
    }


    .header-content {
      text-align: center;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;

      justify-content: space-between;
      align-items: center;
      padding: 1rem;
    }

    .logo-block {
      text-align: center;

      align-items: center;
    }

    .logo {
      font-size: 3rem;
      font-weight: 700;
      background: linear-gradient(to right, #ff8a00, #e52e71);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .tagline {
      margin-top: 0.5rem;
      font-size: 1.1rem;
      font-weight: 300;
      color: rgba(255, 255, 255, 0.85);
      letter-spacing: 1px;
      text-align: center;
    }



    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(50px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    .hero {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 24px;
      padding: 3rem 2rem;
      margin: -60px auto 3rem auto;
      /* less overlap so header movement is visible */
      max-width: 1000px;
      text-align: center;
      color: rgba(235, 10, 10, 0.682);
      position: relative;
      z-index: 2;
      /* ensures hero stays above header */
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
      animation: slideIn 1s ease-out 0.3s both;
    }



    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(100px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .hero h2 {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #c8343c, #310e23);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent
    }

    .hero p {
      font-size: 1.05rem;
      color: rgba(255, 255, 255, 0.9)
    }

    .issue-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      background-color: #95d2df;
      gap: 1.5rem;
      margin: 2rem;
      padding: 0 1rem
    }

    .card {
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 2rem;
      text-align: center;
      color: #fff;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: transform .22s ease, filter .22s ease;
    }

    .card:hover {
      transform: translateY(-8px) scale(1.03);
      filter: brightness(1.08)
    }

    .card1 {
      background: rgba(241, 159, 159, 0.55)
    }

    .card2 {
      background: rgb(179, 248, 162)
    }

    .card3 {
      background: rgb(247, 248, 152)
    }

    .card4 {
      background: rgb(162, 243, 247)
    }

    .card5 {
      background: rgb(247, 185, 165)
    }

    .card-icon {
      font-size: 3.6rem;
      margin-bottom: 0.6rem;
      display: block
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: 700
    }

    .impact {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 24px;
      padding: 2.5rem;
      margin: 2rem;
      text-align: center;
      color: #000000
    }

    .impact h3 {
      background: linear-gradient(135deg, #1dd1a1, #54a0ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent
    }

    .impact-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      margin-top: 1rem
    }

    .impact-box {
      background: rgba(255, 255, 255, 0.08);
      padding: 1.4rem;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      font-size: 1.3rem;
      font-weight: 700
    }

    footer {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: rgba(0, 0, 0, 0.9);
  padding: 0.8rem 1rem;
  display: flex;
  justify-content: space-around;
  align-items: center;
  border-top: 1px solid #333;
  z-index: 1000;
}

footer button {
  background: none;
  border: none;
  color: #fff;
  font-size: 1rem;
  cursor: pointer;
}
footer button:hover {
  color: #00bfff;
}


    /* profile button (visible) */
    .profile-btn {
      position: absolute;
      right: 20px;
      top: 20px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.18);
      color: #fff;
      font-weight: 700;
      font-size: 1.05rem;
      cursor: pointer;
      z-index: 3;
    }

    /* ====== Profile Drawer (REPLACE your existing .profile-panel / .close-x rules with this) ====== */
    .profile-panel {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100%;
      max-width: 420px;
      /* won't grow too wide on large screens */
      background: #fff;
      box-shadow: -8px 0 30px rgba(0, 0, 0, 0.25);
      transition: right .28s ease-in-out;
      padding: 20px;
      /* main padding */
      padding-top: 64px;
      /* important: push content below the close button */
      box-sizing: border-box;
      z-index: 1200;
      overflow-y: auto;
    }

    /* open state */
    .profile-panel.open {
      right: 0;
    }

    /* header title - give right padding so it never sits below the close button */
    .profile-panel h2 {
      margin: 0 0 6px 0;
      font-size: 1.15rem;
      padding-right: 56px;
      /* reserve space for the close button */
    }

    /* body text inside panel */
    .profile-panel p {
      margin: 0.45rem 0;
      color: #222;
    }

    .profile-panel .small {
      color: #666;
      font-size: 0.9rem;
    }

    /* Buttons in the panel (BUT NOT the close-X) */
    .profile-panel button:not(.close-x) {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 8px;
      border: none;
      background: #764ba2;
      color: #fff;
      cursor: pointer;
      width: 100%;
      display: inline-block;
      box-sizing: border-box;
    }

    /* small floating close button (explicitly sized so it doesn't expand) */
    .close-x {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 36px;
      height: 36px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      border: none;
      background: #e74c3c;
      /* 🔴 red background */
      font-size: 16px;
      line-height: 1;
      cursor: pointer;
      color: #fff;
      /* white "x" */
      z-index: 1300;
      transition: background 0.2s ease-in-out;
    }

    /* hover effect */
    .close-x:hover {
      background: #c0392b;
      /* darker red on hover */
    }


    /* accessibility focus */
    .close-x:focus {
      outline: 2px solid rgba(118, 75, 162, 0.25);
      outline-offset: 2px;
    }

    /* responsive tweaks */
    @media (max-width: 768px) {
      .profile-panel {
        width: 100%;
        right: -100%;
        padding-top: 72px;
        /* give a little extra top space on small screens */
      }

      .profile-panel h2 {
        padding-right: 56px;
      }

      .close-x {
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
      }
    }

    /* ====== Chatbot Styles ====== */
    .chatbot-icon {
      position: fixed;
      bottom: 20px;
      right: 20px;
      height: 55px;
      width: 55px;
      border-radius: 50%;
      background: #007bff;
      color: white;
      font-size: 24px;
      border: none;
      cursor: pointer;
      box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 2000;
    }

    .chatbot {
      display: none;
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 300px;
      height: 400px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.18);
      z-index: 2001;
      flex-direction: column;
      overflow: hidden;
      animation: chatbot-pop 0.2s;
    }

    @keyframes chatbot-pop {
      0% {
        transform: scale(0.8);
        opacity: 0;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .chat_head {
      background: #1976d2;
      color: #fff;
      padding: 1rem 1.5rem 1rem 1rem;
      display: flex;
      align-items: center;
      position: relative;
      min-height: 56px;
    }

    .chat_head h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
      flex: 1;
    }

    .close_btn {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
      position: absolute;
      top: 12px;
      right: 18px;
      transition: color 0.2s;
    }

    .close_btn:hover {
      color: #ff5252;
    }

    .chat_body {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      background: #f8fafd;
      font-size: 1rem;
      min-height: 120px;
      max-height: 300px;
    }

    .user_message {
      background: #007bff;
      color: #fff;
      margin: 8px 0 8px auto;
      padding: 8px 14px;
      border-radius: 16px 16px 4px 16px;
      width: fit-content;
      max-width: 80%;
      font-size: 14px;
    }

    .bot_message {
      background: #e3f0ff;
      color: #222;
      margin: 8px 0;
      padding: 8px 14px;
      border-radius: 16px 16px 16px 4px;
      width: fit-content;
      max-width: 80%;
      font-size: 14px;
    }

    .chat_input_wrapper {
      display: flex;
      padding: 0.8em;
      border-top: 1px solid #e0e0e0;
      background: #f7f7f7;
    }

    .chat_input_wrapper input {
      width: 75%;
      padding: 0.6em;
      border: 1px solid #c4c2c2;
      border-radius: 0.5em;
      font-size: 1rem;
      resize: none;
      max-height: 10rem;
      margin-right: 0.5em;
    }

    .send_button {
      width: 25%;
      max-height: 40px;
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 0.5em;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .send_button:hover {
      background: #1251a3;
    }

    .leaderboard-btn {
  text-align: center;
  margin: 40px 0;
   margin-bottom: 60px;
}

.leaderboard-btn a {
  display: inline-block;
  position: relative;
  padding: 15px 40px;
  background: #0077b6;
  color: #fff;
  font-size: 1.3rem;
  font-weight: bold;
  text-decoration: none;
  border-radius: 12px;
  overflow: hidden;
  transition: background 0.3s ease;
}

.leaderboard-btn a:hover {
  background: #005f87;
}


.leaderboard-btn a::before {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 200%;
  height: 200%;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  transform: translate(-50%, -50%) scale(0);
  animation: wave 2s infinite ease-out;
}

@keyframes wave {
  0% {
    transform: translate(-50%, -50%) scale(0.5);
    opacity: 0.8;
  }
  70% {
    transform: translate(-50%, -50%) scale(1.5);
    opacity: 0;
  }
  100% {
    transform: translate(-50%, -50%) scale(2);
    opacity: 0;
  }
}

  </style>
</head>

<body>
  <header>
    <div class="header-content">
      <div class="logo-block">
        <div class="logo" id="logo">CivicRevolution</div>
        <div class="tagline">Empowering Citizens • Building Tomorrow</div>
      </div>
      <button id="profileBtn" class="profile-btn" title="Open profile">👤</button>
    </div>
  </header>

  <!-- Chatbot -->
  <div id="chatbot_container">
    <button id="chatbot_icon" class="chatbot-icon">💬</button>
    <div id="chatbot" class="chatbot">
      <div class="chat_head">
        <h3>Chatbot</h3>
        <button id="closeChat" class="close_btn">&times;</button>
      </div>
      <div id="chatBody" class="chat_body"></div>
      <div class="chat_input_wrapper">
        <input id="chatInput" type="text" placeholder="Type your message..." />
        <button id="sendBtn" class="send_button">Send</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="hero">
      <h2>Welcome 👋 <span id="userName">Guest</span></h2>
      <p>Report issues, track progress, and make your community stronger together</p>
    </div>

    <div class="issue-grid" id="issueGrid">
      <div class="card card1" data-issue="Pothole">
        <span class="card-icon">🚧</span>
        <div class="card-title">Road & Pothole Issues</div>
      </div>
      <div class="card card2" data-issue="Garbage">
        <span class="card-icon">♻</span>
        <div class="card-title">Waste Management</div>
      </div>
      <div class="card card3" data-issue="Street Light">
        <span class="card-icon">💡</span>
        <div class="card-title">Street Lighting</div>
      </div>
      <div class="card card4" data-issue="Water Leakage">
        <span class="card-icon">💧</span>
        <div class="card-title">Water Infrastructure</div>
      </div>
      <div class="card card5" data-issue="Other">
        <span class="card-icon">⚡</span>
        <div class="card-title">Other Issues</div>
      </div>
    </div>
<div class="impact" id="liveDashboard">
  <h3>📡 Live Dashboard</h3>
  <div class="impact-stats">
    <div class="impact-box">
      📊 <span id="totalReports">0</span><br>
      <small class="small">Total Reports</small>
    </div>
    <div class="impact-box">
      ⏳ <span id="inProgress">0</span><br>
      <small class="small">In Progress</small>
    </div>
    <div class="impact-box">
      ✅ <span id="resolved">0</span><br>
      <small class="small">Resolved</small>
    </div>
  </div>
</div>

  </div>

<div class="leaderboard-btn">
  <a href="leaderboard.html">🏆 View Leaderboard</a>
</div>

  <footer>
    <button onclick="window.location.href='home.html'">🏠 Home</button>
    <button onclick="window.location.href='report.html'">📝 Report</button>
    <button onclick="window.location.href='feedback.html'">🗺 Feedback</button>
    <button onclick="window.location.href='murli.html'"> Maps</button>
    <button onclick="window.location.href='about.html'"> About us</button>


    <button id="footerLogout">🚪 Logout</button>
  </footer>

  <!-- Profile Panel -->
  <aside id="profilePanel" class="profile-panel" aria-hidden="true">
    <button class="close-x" id="closeProfile">✕</button>
    <h2>👤 Profile</h2>
    <p><strong>Name:</strong> <span id="profileName">Loading...</span></p>
    <p><strong>Email:</strong> <span id="profileEmail">Loading...</span></p>
    <p><strong>Phone:</strong> <span id="profilePhone">Loading...</span></p>
    <hr style="margin:12px 0;border:none;border-top:1px solid #eee" />
    <h3 style="margin:6px 0">📌 My Reports</h3>
    <ul id="myReports" style="margin-left:1rem;color:#333">
      <li>🚧 Pothole – ⏳ Pending</li>
      <li>🗑 Garbage – 🔧 In Progress</li>
      <li>💡 Street Light – ✅ Resolved</li>
    </ul>
    <hr style="margin:12px 0;border:none;border-top:1px solid #eee" />
    <button id="profileLogout">🚪 Logout</button>
  </aside>

<!-- Supabase + app logic -->
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
  const SUPABASE_URL = 'https://xnqtjcovuqzajuqzaunf.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhucXRqY292dXF6YWp1cXphdW5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MzIyMzEsImV4cCI6MjA3MzEwODIzMX0.YbmzZoqOdIX_inX-khtpg1IsiCNUROAvR4Z2N85lEvM';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

//my part
  
async function submitReport(userId, description, photoUrl, location) {
  // Insert the report
  const { data: report, error: reportErr } = await supabase
    .from('reports')
    .insert([{ user_id: userId, description, photo_url: photoUrl, location }])

  if (reportErr) {
    console.error("Report submission failed:", reportErr.message)
    return
  }

  // Increment points and reports_count
  const { data: user, error: userErr } = await supabase
    .from('userss')
    .update({
      reports_count: supabase.raw('reports_count + 1'),
      points: supabase.raw('points + 1')
    })
    .eq('id', userId)

  if (userErr) console.error("Points update failed:", userErr.message)

  console.log("Report submitted and points updated!")
}

async function handleReportSubmission(userId, description, photoUrl, location) {
  if (!userId) return;
  
  // Submit report and increment points
  await submitReportWithPoints(userId, description, photoUrl, location);
  
  // Update user's rank and leaderboard
  await showMyRank(userId);
  await fetchLeaderboard();
}

async function submitReportWithPoints(userId, description, photoUrl, location) {
  // Insert report
  const { data: report, error: reportErr } = await supabase
    .from('reports')
    .insert([{ user_id: userId, description, photo_url: photoUrl, location }]);

  if (reportErr) { console.error("Report submission failed:", reportErr.message); return; }

  // Increment points & reports_count
  const { data: user, error: userErr } = await supabase
    .from('userss')
    .update({
      reports_count: supabase.raw('reports_count + 1'),
      points: supabase.raw('points + 1')
    })
    .eq('id', userId);

  if (userErr) console.error("Points update failed:", userErr.message);

  console.log("Report submitted and points updated!");
}

// -----------------------------
// 2️⃣ Show logged-in user rank
// -----------------------------
async function showMyRank(userId) {
  const { data } = await supabase
    .from('userss')
    .select('id, name, points')
    .order('points', { ascending: false });

  const rank = data.findIndex(u => u.id === userId) + 1;
  const points = data.find(u => u.id === userId)?.points || 0;

  const rankDiv = document.querySelector('.your-rank');
  if (rankDiv) rankDiv.textContent = `Your Rank: #${rank} (${points} points)`;
}

// -----------------------------
// 3️⃣ Fetch top leaderboard
// -----------------------------
async function fetchLeaderboard(limit = 10) {
  const { data, error } = await supabase
    .from('userss')
    .select('id, name, points')
    .order('points', { ascending: false })
    .limit(limit);

  if (error) { console.error("Leaderboard fetch failed:", error.message); return; }

  const leaderboardEl = document.querySelector('.leaderboard');
  if (!leaderboardEl) return;

  leaderboardEl.innerHTML = '';
  data.forEach((user, i) => {
    const div = document.createElement('div');
    div.textContent = `${i + 1}. ${user.name || 'Anonymous'} — ${user.points} pts`;
    leaderboardEl.appendChild(div);
  });
}



//my part end
  /* ---------------- USER FETCH ---------------- */
  async function fetchUserFromSupabase(userId) {
    try {
      if (!userId) return null;
      const { data, error } = await supabase
        .from('registrations')
        .select('username, email, phone')
        .eq('id', userId)
        .single();
      if (error) {
        console.warn('Supabase fetch error:', error);
        return null;
      }
      return data;
    } catch (err) {
      console.error('Supabase error', err);
      return null;
    }
  }

  window._fetchUserFromSupabase = fetchUserFromSupabase;

  /* ---------------- LIVE DASHBOARD ---------------- */
  async function refreshDashboard() {
    const { data, error } = await supabase
      .from('complaints')
      .select('status');

    if (error) {
      console.error("Dashboard fetch error:", error);
      return;
    }

    const total = data.length;
    const inProgress = data.filter(r => r.status === 'In Progress').length;
    const resolved = data.filter(r => r.status === 'Solved').length;

    document.getElementById('totalReports').textContent = total;
    document.getElementById('inProgress').textContent = inProgress;
    document.getElementById('resolved').textContent = resolved;
  }

  // Initial load
  refreshDashboard();



// Live update leaderboard whenever points change
supabase
  .channel('leaderboard-changes')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'userss' }, async () => {
    if (userId) {
      await showMyRank(userId);      // update logged-in user's rank
      await fetchLeaderboard();      // update top 10 leaderboard
    }
  })
  .subscribe();

  

  // Realtime updates whenever reports table changes
  supabase
    .channel('reports-changes')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'reports' }, () => {
      refreshDashboard();
    })
    .subscribe();

    // Show current user's rank and top leaderboard when page loads
if (userId) {
  showMyRank(userId);   // display logged-in user's rank
  fetchLeaderboard();   // display top 10 leaderboard
}

</script>


  <script>
    const userNameEl = document.getElementById('userName');
    const profileNameEl = document.getElementById('profileName');
    const profileEmailEl = document.getElementById('profileEmail');
    const profilePhoneEl = document.getElementById('profilePhone');
    const profileBtn = document.getElementById('profileBtn');
    const profilePanel = document.getElementById('profilePanel');
    const closeProfileBtn = document.getElementById('closeProfile');
    const profileLogout = document.getElementById('profileLogout');
    const footerLogout = document.getElementById('footerLogout');
    const logo = document.getElementById('logo');

    const localName = localStorage.getItem('username') || localStorage.getItem('userName') || 'Guest';
    const localEmail = localStorage.getItem('email') || '';
    const localPhone = localStorage.getItem('phone') || '';
    const userId = localStorage.getItem('userId');

    userNameEl.textContent = localName;
    profileNameEl.textContent = localName || 'N/A';
    profileEmailEl.textContent = localEmail || 'N/A';
    profilePhoneEl.textContent = localPhone || 'N/A';

    if (localName && localName !== 'Guest') {
      profileBtn.textContent = localName.charAt(0).toUpperCase();
    } else {
      profileBtn.textContent = '👤';
    }

    function openProfile() {
      profilePanel.classList.add('open');
      profilePanel.setAttribute('aria-hidden', 'false');
    }
    function hideProfile() {
      profilePanel.classList.remove('open');
      profilePanel.setAttribute('aria-hidden', 'true');
    }

    profileBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      openProfile();
    });
    closeProfileBtn.addEventListener('click', hideProfile);
    logo.addEventListener('click', () => openProfile());

    document.addEventListener('click', (e) => {
      if (profilePanel.classList.contains('open')) {
        const inside = profilePanel.contains(e.target) || profileBtn.contains(e.target) || logo.contains(e.target);
        if (!inside) hideProfile();
      }
    });

    function doLogout() {
      localStorage.removeItem('loggedIn');
      localStorage.removeItem('userId');
      localStorage.removeItem('username');
      localStorage.removeItem('email');
      localStorage.removeItem('phone');
      window.location.href = 'index.html';
    }
    profileLogout.addEventListener('click', doLogout);
    footerLogout.addEventListener('click', doLogout);

    document.querySelectorAll('.card').forEach(card => {
      card.addEventListener('click', () => {
        const issue = card.dataset.issue || 'Other';
        window.location.href = `report.html?issue=${encodeURIComponent(issue)}`;
      });
    });

    (async function refreshFromSupabase() {
      try {
        if (!userId) return;
        if (typeof window._fetchUserFromSupabase === 'function') {
          const supaData = await window._fetchUserFromSupabase(userId);
          if (supaData) {
            const name = supaData.username || supaData.name || localName;
            const email = supaData.email || localEmail;
            const phone = supaData.phone || localPhone;
            userNameEl.textContent = name;
            profileNameEl.textContent = name || 'N/A';
            profileEmailEl.textContent = email || 'N/A';
            profilePhoneEl.textContent = phone || 'N/A';
            localStorage.setItem('username', name || '');
            localStorage.setItem('email', email || '');
            localStorage.setItem('phone', phone || '');
            profileBtn.textContent = (name && name !== 'Guest') ? name.charAt(0).toUpperCase() : '👤';
          }
        }
      } catch (err) {
        console.warn('Could not fetch from Supabase:', err);
      }
    })();

    window.addEventListener('scroll', () => {
      const scrolled = window.pageYOffset;
      const header = document.querySelector('header');
      if (header) {
        header.style.transform = `translateY(${scrolled * 0.5}px)`;
      }
    });

    // Chatbot logic (withdraw option removed)
    document.addEventListener("DOMContentLoaded", function () {
      const chatbotIcon = document.getElementById("chatbot_icon");
      const chatbot = document.getElementById("chatbot");
      const closeChat = document.getElementById("closeChat");
      const sendBtn = document.getElementById("sendBtn");
      const chatInput = document.getElementById("chatInput");
      const chatBody = document.getElementById("chatBody");

      let awaitingComplaintNumber = false;

      chatbotIcon.addEventListener("click", () => {
        chatbot.style.display = "flex";
        chatBody.innerHTML = "";
        addBotMessage("Hello! How can I help you today?");
        showOptions();
      });

      closeChat.addEventListener("click", () => {
        chatbot.style.display = "none";
        awaitingComplaintNumber = false;
      });

      function addUserMessage(text) {
        const msg = document.createElement("div");
        msg.className = "user_message";
        msg.textContent = text;
        chatBody.appendChild(msg);
        chatBody.scrollTop = chatBody.scrollHeight;
      }

      function addBotMessage(text) {
        const msg = document.createElement("div");
        msg.className = "bot_message";
        msg.textContent = text;
        chatBody.appendChild(msg);
        chatBody.scrollTop = chatBody.scrollHeight;
      }

      function showOptions() {
        const options = [
          { label: "Add Your Complaint", value: "add" },
          { label: "Track Your Complaint", value: "track" },
          { label: "Contact Our Executives", value: "contact" }
        ];
        const btnGroup = document.createElement("div");
        btnGroup.style.display = "flex";
        btnGroup.style.flexDirection = "column";
        btnGroup.style.gap = "8px";
        options.forEach(opt => {
          const btn = document.createElement("button");
          btn.textContent = opt.label;
          btn.style.background = "#007bff";
          btn.style.color = "#fff";
          btn.style.border = "none";
          btn.style.borderRadius = "8px";
          btn.style.padding = "8px 0";
          btn.style.fontSize = "14px";
          btn.style.cursor = "pointer";
          btn.onclick = () => handleOption(opt.value, btnGroup);
          btnGroup.appendChild(btn);
        });
        chatBody.appendChild(btnGroup);
        chatBody.scrollTop = chatBody.scrollHeight;
      }

      function handleOption(value, btnGroup) {
        btnGroup.remove();
        if (value === "add") {
          addBotMessage("Redirecting you to the complaint form...");
          setTimeout(() => window.location.href = "report.html", 1200);
        } else if (value === "track") {
          addBotMessage("Please enter your complaint number:");
          awaitingComplaintNumber = true;
        } else if (value === "contact") {
          askContactDetails();
        }
      }

      function askContactDetails() {
        addBotMessage("Please enter your name and mobile number below:");
        const form = document.createElement("div");
        form.style.display = "flex";
        form.style.flexDirection = "column";
        form.style.gap = "6px";
        form.style.margin = "8px 0";

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.placeholder = "Your Name";
        nameInput.style.padding = "6px";
        nameInput.style.borderRadius = "5px";
        nameInput.style.border = "1px solid #ccc";
        nameInput.style.fontSize = "13px";

        const phoneInput = document.createElement("input");
        phoneInput.type = "tel";
        phoneInput.placeholder = "Mobile Number (10 digits)";
        phoneInput.style.padding = "6px";
        phoneInput.style.borderRadius = "5px";
        phoneInput.style.border = "1px solid #ccc";
        phoneInput.style.fontSize = "13px";

        const submitBtn = document.createElement("button");
        submitBtn.textContent = "Submit";
        submitBtn.style.background = "#007bff";
        submitBtn.style.color = "#fff";
        submitBtn.style.border = "none";
        submitBtn.style.borderRadius = "6px";
        submitBtn.style.padding = "7px 0";
        submitBtn.style.fontSize = "13px";
        submitBtn.style.cursor = "pointer";

        form.appendChild(nameInput);
        form.appendChild(phoneInput);
        form.appendChild(submitBtn);
        chatBody.appendChild(form);
        chatBody.scrollTop = chatBody.scrollHeight;

        submitBtn.onclick = () => {
          const name = nameInput.value.trim();
          const phone = phoneInput.value.trim();
          if (!/^[a-zA-Z ]{4,}$/.test(name)) {
            alert("Please enter a valid name.");
            nameInput.focus();
            return;
          }
          if (!/^\d{10}$/.test(phone)) {
            alert("Please enter a valid 10 digit mobile number.");
            phoneInput.focus();
            return;
          }
          addUserMessage(`Name: ${name}`);
          addUserMessage(`Mobile Number: ${phone}`);
          form.remove();
          addBotMessage("Thank you! Our executives will connect with you shortly.");
          setTimeout(showOptions, 1000);
        };
      }

      // ✅ Fixed closing braces here
      sendBtn.addEventListener("click", () => {
        const text = chatInput.value.trim();
        if (!text) return;
        addUserMessage(text);

        if (awaitingComplaintNumber) {
          addBotMessage(`Your complaint (${text}) has been processed and will be solved soon.`);
          awaitingComplaintNumber = false;
          setTimeout(showOptions, 1000);
        }

        chatInput.value = ""; // moved inside correctly
      });

      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          sendBtn.click();
        }
      });

      // Hide chatbot on load
      chatbot.style.display = "none";
    });

  </script>
</body>


</html>
